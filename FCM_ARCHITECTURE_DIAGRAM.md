# Firebase Cloud Messaging - System Architecture

## Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MEDITRACK FCM SYSTEM                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT (React + Vite)                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. USER LOGIN                                                     â”‚
â”‚     â†“                                                              â”‚
â”‚  2. useFcmRegistration Hook Activates                             â”‚
â”‚     â”œâ”€ Request Notification Permission (once)                    â”‚
â”‚     â”œâ”€ Register Service Worker                                   â”‚
â”‚     â”œâ”€ Generate FCM Token (via firebase.js)                      â”‚
â”‚     â””â”€ Send Token to Backend                                     â”‚
â”‚                                                                     â”‚
â”‚  3. SERVICE WORKER                                                â”‚
â”‚     â”œâ”€ Listens for background messages                           â”‚
â”‚     â”œâ”€ Displays notifications when tab closed                    â”‚
â”‚     â””â”€ Called: firebase-messaging-sw.js                          â”‚
â”‚                                                                     â”‚
â”‚  4. FOREGROUND LISTENER                                            â”‚
â”‚     â”œâ”€ Listens for messages when tab active                      â”‚
â”‚     â””â”€ Shows OS notification                                     â”‚
â”‚                                                                     â”‚
â”‚  5. ALERT MODAL                                                    â”‚
â”‚     â””â”€ Existing in-page alerts (UNCHANGED)                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                           â”‚
                    â†“                           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Browser Notification â”‚    â”‚ Firebase Console     â”‚
        â”‚ Permission Storage   â”‚    â”‚ (meditrack-51fcc)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â†“
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Cloud Messaging API  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚             â”‚                       â”‚
                    â†“             â†“                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Service Worker   â”‚ â”‚ Foreground App   â”‚ â”‚ (Future: APK)  â”‚
        â”‚ (Tab Closed)     â”‚ â”‚ (Tab Open)       â”‚ â”‚ Native Push    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKEND (Node.js + Express)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. TOKEN REGISTRATION                                             â”‚
â”‚     POST /api/notifications/token                                 â”‚
â”‚     â”œâ”€ Receive FCM token from client                             â”‚
â”‚     â”œâ”€ Store in user.fcmTokens array                             â”‚
â”‚     â””â”€ Keep last 5 tokens                                        â”‚
â”‚                                                                     â”‚
â”‚  2. CRON JOBS (Every Minute)                                       â”‚
â”‚     â”œâ”€ Check Medicine Reminders                                  â”‚
â”‚     â”‚  â”œâ”€ Match: time === currentTime                           â”‚
â”‚     â”‚  â”œâ”€ Get user.fcmTokens                                   â”‚
â”‚     â”‚  â””â”€ Call sendPushNotification()                           â”‚
â”‚     â”‚                                                            â”‚
â”‚     â””â”€ Check Appointment Reminders                              â”‚
â”‚        â”œâ”€ Match: date + time === current                        â”‚
â”‚        â”œâ”€ Get user.fcmTokens                                   â”‚
â”‚        â””â”€ Call sendPushNotification()                           â”‚
â”‚                                                                     â”‚
â”‚  3. PUSH SENDER (pushNotifier.js)                                  â”‚
â”‚     â”œâ”€ Deduplicate tokens                                         â”‚
â”‚     â”œâ”€ Validate FCM_SERVER_KEY                                    â”‚
â”‚     â”œâ”€ Send to Firebase Cloud Messaging API                       â”‚
â”‚     â””â”€ Log success/failure                                        â”‚
â”‚                                                                     â”‚
â”‚  4. MONGODB STORAGE                                                â”‚
â”‚     â””â”€ user.fcmTokens: [                                          â”‚
â”‚        {                                                          â”‚
â”‚          token: "fcm-token-xyz",                                  â”‚
â”‚          platform: "web",                                         â”‚
â”‚          updatedAt: Date                                          â”‚
â”‚        },                                                         â”‚
â”‚        ...                                                        â”‚
â”‚     ]                                                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Firebase Cloud       â”‚
        â”‚ Messaging API        â”‚
        â”‚ (fcm.googleapis.com) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NOTIFICATION DELIVERY PATHS                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  SCENARIO 1: Tab Open (Foreground)                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                               â”‚
â”‚                                                                     â”‚
â”‚  Firebase API                                                      â”‚
â”‚       â†“                                                            â”‚
â”‚  onMessage Listener (fcm.js)                                       â”‚
â”‚       â†“                                                            â”‚
â”‚  Show OS Notification                                             â”‚
â”‚       â†“                                                            â”‚
â”‚  OS Dialog Box (browser-level)                                     â”‚
â”‚                                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                     â”‚
â”‚  SCENARIO 2: Tab Closed/Minimized (Background)                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â”‚                                                                     â”‚
â”‚  Firebase API                                                      â”‚
â”‚       â†“                                                            â”‚
â”‚  Service Worker                                                    â”‚
â”‚  (firebase-messaging-sw.js)                                        â”‚
â”‚       â†“                                                            â”‚
â”‚  onBackgroundMessage Handler                                       â”‚
â”‚       â†“                                                            â”‚
â”‚  OS Notification                                                   â”‚
â”‚       â†“                                                            â”‚
â”‚  System Tray / Notification Center                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MEDICINE REMINDER FLOW (Example)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  User Creates:                                                     â”‚
â”‚  Medicine: "Aspirin"                                               â”‚
â”‚  Time: "09:00 AM"                                                  â”‚
â”‚                                                                     â”‚
â”‚  At 09:00 AM:                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
â”‚  Cron job runs (every minute)                                      â”‚
â”‚       â†“                                                            â”‚
â”‚  Converts "09:00 AM" to 24-hour: "09:00"                           â”‚
â”‚       â†“                                                            â”‚
â”‚  Matches current time: "09:00"                                     â”‚
â”‚       â†“                                                            â”‚
â”‚  Query: SELECT from Medicines WHERE time = "09:00"                â”‚
â”‚       â†“                                                            â”‚
â”‚  Found: 1 medicine                                                â”‚
â”‚       â†“                                                            â”‚
â”‚  Populate user â†’ Get fcmTokens                                     â”‚
â”‚       â†“                                                            â”‚
â”‚  Send FCM Push:                                                    â”‚
â”‚  {                                                                 â”‚
â”‚    title: "Medicine Reminder",                                     â”‚
â”‚    body: "Time to take Aspirin - After food",                      â”‚
â”‚    data: {                                                         â”‚
â”‚      type: "medicine",                                             â”‚
â”‚      medicineName: "Aspirin",                                      â”‚
â”‚      foodTiming: "after food"                                      â”‚
â”‚    },                                                              â”‚
â”‚    tag: "medicine-id-09:00"  // prevents duplicates              â”‚
â”‚  }                                                                 â”‚
â”‚       â†“                                                            â”‚
â”‚  Firebase Cloud Messaging                                          â”‚
â”‚       â†“                                                            â”‚
â”‚  User's Device                                                     â”‚
â”‚       â†“                                                            â”‚
â”‚  OS Notification Appears                                           â”‚
â”‚  "ğŸ’Š Medicine Reminder"                                            â”‚
â”‚  "Time to take Aspirin - After food"                               â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APPOINTMENT REMINDER FLOW (Example)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  User Creates:                                                     â”‚
â”‚  Doctor: "Dr. Smith"                                               â”‚
â”‚  Hospital: "City Hospital"                                         â”‚
â”‚  Date: "2025-01-13"                                                â”‚
â”‚  Time: "02:30 PM"                                                  â”‚
â”‚                                                                     â”‚
â”‚  At 02:30 PM on 2025-01-13:                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚  Cron job runs (every minute)                                      â”‚
â”‚       â†“                                                            â”‚
â”‚  Converts "02:30 PM" to 24-hour: "14:30"                           â”‚
â”‚       â†“                                                            â”‚
â”‚  Matches current date AND time                                     â”‚
â”‚       â†“                                                            â”‚
â”‚  Query: SELECT from Appointments                                   â”‚
â”‚         WHERE date = "2025-01-13" AND time = "14:30"              â”‚
â”‚       â†“                                                            â”‚
â”‚  Found: 1 appointment                                              â”‚
â”‚       â†“                                                            â”‚
â”‚  Populate user â†’ Get fcmTokens                                     â”‚
â”‚       â†“                                                            â”‚
â”‚  Send FCM Push:                                                    â”‚
â”‚  {                                                                 â”‚
â”‚    title: "Appointment Reminder",                                  â”‚
â”‚    body: "Appointment with Dr. Smith at City Hospital",            â”‚
â”‚    data: {                                                         â”‚
â”‚      type: "appointment",                                          â”‚
â”‚      doctorName: "Dr. Smith",                                      â”‚
â”‚      hospitalName: "City Hospital"                                 â”‚
â”‚    },                                                              â”‚
â”‚    tag: "appointment-id-14:30"  // prevents duplicates            â”‚
â”‚  }                                                                 â”‚
â”‚       â†“                                                            â”‚
â”‚  Firebase Cloud Messaging                                          â”‚
â”‚       â†“                                                            â”‚
â”‚  User's Device                                                     â”‚
â”‚       â†“                                                            â”‚
â”‚  OS Notification Appears                                           â”‚
â”‚  "ğŸ“… Appointment Reminder"                                         â”‚
â”‚  "Appointment with Dr. Smith at City Hospital"                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FILE DEPENDENCY TREE                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  App.jsx                                                            â”‚
â”‚  â”œâ”€ useFcmRegistration.js                                          â”‚
â”‚  â”‚  â”œâ”€ fcm.js                                                      â”‚
â”‚  â”‚  â”‚  â”œâ”€ firebase.js                                              â”‚
â”‚  â”‚  â”‚  â””â”€ api.js â†’ notificationAPI                                 â”‚
â”‚  â”‚  â””â”€ AuthContext                                                 â”‚
â”‚  â”‚                                                                 â”‚
â”‚  â””â”€ Service Worker (async)                                        â”‚
â”‚     â””â”€ firebase-messaging-sw.js                                    â”‚
â”‚        (loaded via navigator.serviceWorker.register)               â”‚
â”‚                                                                     â”‚
â”‚  Backend                                                            â”‚
â”‚  â”œâ”€ server.js                                                      â”‚
â”‚  â”‚  â”œâ”€ routes/notifications.js                                     â”‚
â”‚  â”‚  â”‚  â””â”€ controllers/notificationController.js                    â”‚
â”‚  â”‚  â”‚     â””â”€ utils/pushNotifier.js                                â”‚
â”‚  â”‚  â”‚                                                             â”‚
â”‚  â”‚  â””â”€ utils/cronJobs.js                                          â”‚
â”‚  â”‚     â”œâ”€ models/Medicine.js                                      â”‚
â”‚  â”‚     â”œâ”€ models/Appointment.js                                   â”‚
â”‚  â”‚     â””â”€ utils/pushNotifier.js                                   â”‚
â”‚  â”‚                                                                 â”‚
â”‚  â””â”€ models/User.js (fcmTokens field)                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STORAGE HIERARCHY                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Browser                         MongoDB              Firebase      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                         â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  localStorage                     users                Project       â”‚
â”‚  â”œâ”€ token                         â”œâ”€ _id               â”œâ”€ Config     â”‚
â”‚  â”œâ”€ user                          â”œâ”€ email                          â”‚
â”‚  â”œâ”€ meditrack_fcm_token           â”œâ”€ name                          â”‚
â”‚  â”œâ”€ meditrack_fcm_permission_     â”œâ”€ fcmTokens         Messaging    â”‚
â”‚  â”‚  requested                     â”‚  â”œâ”€ token          â”œâ”€ API Keys  â”‚
â”‚  â”œâ”€ fcmRegistered                 â”‚  â”œâ”€ platform       â”œâ”€ Server    â”‚
â”‚  â””â”€ ...                           â”‚  â””â”€ updatedAt      â”‚  Key       â”‚
â”‚                                   â””â”€ ...              â””â”€ VAPID     â”‚
â”‚                                                        Key         â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ENVIRONMENT VARIABLES                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Client (.env.local)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  VITE_FIREBASE_VAPID_KEY=<public-key-from-firebase>               â”‚
â”‚                                                                     â”‚
â”‚  Server (.env)                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚  FCM_SERVER_KEY=<server-key-from-firebase>                        â”‚
â”‚  (plus other existing vars)                                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Concepts

### ğŸ”‘ Three Types of Firebase Keys

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. VAPID KEY (Web Push Certificate)      â”‚
â”‚    â€¢ Location: Settings â†’ Cloud          â”‚
â”‚             Messaging â†’ Web Push certs   â”‚
â”‚    â€¢ Visibility: Public (safe in client) â”‚
â”‚    â€¢ Used by: Browser                    â”‚
â”‚    â€¢ Purpose: Identify browser to FCM    â”‚
â”‚    â€¢ Where: .env.local                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SERVER KEY (Legacy HTTP API)          â”‚
â”‚    â€¢ Location: Settings â†’ Cloud          â”‚
â”‚             Messaging â†’ Server Key       â”‚
â”‚    â€¢ Visibility: Private (secure!)       â”‚
â”‚    â€¢ Used by: Backend                    â”‚
â”‚    â€¢ Purpose: Authenticate with FCM      â”‚
â”‚    â€¢ Where: .env (never git!)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. API KEY (Config)                      â”‚
â”‚    â€¢ Location: Settings â†’ General        â”‚
â”‚    â€¢ Visibility: Public (in code)        â”‚
â”‚    â€¢ Used by: Firebase SDK init          â”‚
â”‚    â€¢ Purpose: Identify Firebase project  â”‚
â”‚    â€¢ Where: firebase.js (hardcoded OK)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š Message Flow Sequence

```
[Client]          [Firebase]          [Server]          [DB]
   â”‚                  â”‚                  â”‚                â”‚
   â”‚â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                  â”‚                â”‚
   â”‚                  â”‚                  â”‚                â”‚
   â”‚â”€ FCM Token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚                â”‚
   â”‚                  â”‚                  â”‚â”€ Store Token â”€â†’â”‚
   â”‚â—„â”€ Token stored â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
   â”‚                  â”‚                  â”‚â—„â”€ Returned â”€â”€â”€â”€â”‚
   â”‚                  â”‚                  â”‚                â”‚
   â”‚                  â”‚                  â”‚ Every Minute:  â”‚
   â”‚                  â”‚                  â”‚ Check Remindersâ”‚
   â”‚                  â”‚                  â”‚                â”‚
   â”‚                  â”‚                  â”‚â”€ Query DB â”€â”€â”€â”€â†’â”‚
   â”‚                  â”‚                  â”‚â—„â”€ Results â”€â”€â”€â”€â”€â”‚
   â”‚                  â”‚                  â”‚                â”‚
   â”‚                  â”‚     Push â”€â”€â”€â”€â”€â”€â”€â†’â”‚                â”‚
   â”‚â—„â”€ Message â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
   â”‚                  â”‚                  â”‚                â”‚
   â”‚â”€ Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

---

**Version:** 1.0
**Date:** January 13, 2026
**Status:** âœ… Complete Implementation
